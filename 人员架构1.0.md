

## VisionMark 协作开发手册

**项目**: Bilibili Ad Skipper - 众测版  
**版本**: v1.0  
**最后更新**: 2026-02-07

---

### 团队成员与分工

| 职责 | 成员 | 核心工作 |
|------|------|---------|
| **项目管理** | 季仲谋 | 统筹开发任务，规范框架，组织协作 |
| **后端开发** | 朱家佑 李陈熙 | Express 服务搭建、API 实现、性能优化 |
| **数据库** | 黄瑞琦 | SQLite 设计、数据模型、查询优化 |
| **前端开发** | 史少凯、张家昊 | Chrome 扩展开发、用户交互、与后端联调 |



### 1. 项目概述

#### 1.1 系统架构

```
┌─────────────────┐      HTTP API      ┌─────────────────┐
│   插件前端      │ ◄────────────────► │   后端服务      │
│ (content.js)    │   JWT Token 认证   │   (Express)     │
└─────────────────┘                    └────────┬────────┘
                                                │
                                         ┌──────┴──────┐
                                         │   数据库    │
                                         │  (SQLite3)  │
                                         └─────────────┘
```

#### 1.2 技术栈速览

| 层级 | 技术 | 负责方 | 关键文件 |
|------|------|--------|---------|
| 扩展端 | Chrome Extension MV3 | 前端 | `extension/content/main.js` |
| API 层 | Express + JWT | 后端 | `server/server.js` |
| 数据层 | better-sqlite3 | 数据库 | `server/database/app.db` |
| 部署 | PM2 + Nginx | 后端 | `ecosystem.config.js` |

---

### 2. 快速开始

#### 2.1 克隆项目

```bash
git clone https://github.com/StudyingHUYANG/VisionMark.git
cd VisionMark
```

#### 2.2 后端启动

```bash
cd server
npm install
npm run dev
```

**验证**: 访问 http://localhost:3000/api/v1/health 返回 `{"ok":true}`

#### 2.3 前端加载

1. Chrome → `chrome://extensions/` → 开启**开发者模式**
2. **加载已解压的扩展程序** → 选择 `VisionMark/extension`
3. 打开 B 站视频，按 `Alt+A` 测试

---

### 3. API 接口规范

#### 3.1 基础信息

| 项 | 值 |
|----|-----|
| Base URL | `http://localhost:3000` (开发) / `https://api.xxx.com` (生产) |
| 认证 | `Authorization: Bearer <token>` |
| 格式 | JSON |

#### 3.2 核心接口

| 方法 | 路径 | 描述 | 负责方 |
|------|------|------|--------|
| POST | `/api/v1/auth/register` | 用户注册 | 后端实现，前端调用 |
| POST | `/api/v1/auth/login` | 用户登录 | 后端实现，前端调用 |
| GET | `/api/v1/segments?bvid=` | 获取广告段 | 后端实现，前端调用 |
| POST | `/api/v1/segments` | 提交广告段 | 后端实现，前端调用 |

#### 3.3 前端调用示例

```javascript
// extension/content/api.js
const API_BASE = 'http://localhost:3000';

async function fetchWithAuth(url, options = {}) {
  const {token} = await chrome.storage.local.get(['token']);
  return fetch(`${API_BASE}${url}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token || ''}`,
      ...options.headers
    }
  });
}
```

---

### 4. 数据库设计

由数据库负责方设计，后端对接使用。

```sql
-- 核心表：广告时段
ad_segments
├── id: INTEGER PK
├── video_id: INTEGER FK  → videos
├── start_time: REAL      -- 开始秒数
├── end_time: REAL        -- 结束秒数
├── ad_type: TEXT         -- video/banner/popup
├── contributor_id: INTEGER FK → users
└── is_active: BOOLEAN DEFAULT 1
```

---

### 5. 开发工作流程

#### 5.1 Git 分支

```
main (保护分支)
  ↑
develop (集成)
  ↑
feature/xxx (功能)
```

#### 5.2 协作流程

1. **前端需求** → 与后端确认接口 → 后端提供 mock → 前端开发
2. **后端变更** → 更新本文档第 3 节 → 通知前端 → 联调
3. **数据库变更** → 由数据库负责方提供迁移脚本 → 后端执行

#### 5.3 提交规范

| 前缀 | 用途 |
|------|------|
| `feat:` | 新功能 |
| `fix:` | 修复 Bug |
| `docs:` | 文档更新 |
| `refactor:` | 重构 |

---

### 6. 联调检查清单

| 检查项 | 后端 | 前端 |
|--------|------|------|
| CORS 配置 | ✅ | - |
| Token 存储 | - | ✅ |
| 错误处理 | ✅ | ✅ |
| 超时处理 | ✅ | ✅ |

---

### 7. 部署与上线

由后端负责部署，前端配合测试。

| 环境 | URL | 状态 |
|------|-----|------|
| 开发 | `localhost:3000` | 本地 |
| 生产 | `https://api.xxx.com` | 已部署 |

**上线前检查**:
- [ ] 版本号更新
- [ ] 数据库迁移
- [ ] 前端扩展打包测试

---

### 8. 快速参考

```bash
# 本地启动
cd server && npm run dev

# 查看日志
pm2 logs

# 扩展刷新
# chrome://extensions/ 点击刷新按钮
```

**文档维护**: 项目管理  
**更新**: 接口变更时同步修改
