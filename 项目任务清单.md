B站广告跳过插件 - 项目任务清单

> 更新时间：2025-02-08
> 项目状态：核心功能已完成，进入完善阶段

---

🔨 开发环境
- 后端：Node.js + Express + SQLite
- 前端：Chrome Extension + JavaScript
- 数据库：SQLite (better-sqlite3)
- 测试账号：admin/admin

---

🎯 待开发任务

🔴 优先级1：核心功能验证与完善

后端开发（朱家佑、李陈熙）

1. 统计数据API
**功能描述**：提供整体数据统计接口

**子任务**：
- [ ] 创建获取总体统计API (`GET /api/v1/stats/overview`)
  - 总用户数
  - 总标注数
  - 总投票数（投票系统完成后）
- [ ] 创建获取用户贡献API (`GET /api/v1/user/contributions`)
  - 返回某个用户的所有标注记录
  - 按时间倒序排列
  - 支持分页查询
- [ ] 创建获取热门视频API (`GET /api/v1/stats/popular-videos`)
  - 返回标注最多的视频TOP 20
- [ ] 创建获取活跃用户API (`GET /api/v1/stats/top-users`)
  - 返回积分最高的用户TOP 10

2. 删除标注API
**功能描述**：允许用户删除自己的标注

**子任务**：
- [ ] 创建删除API (`DELETE /api/v1/segments/:id`)
  - 验证用户是否为标注创建者
  - 删除标注记录
  - 级联删除相关投票记录
- [ ] 添加权限验证中间件
  - 检查contributor_id是否匹配
  - 返回403错误如果不是创建者

3. 批量查询API
**功能描述**：一次查询多个视频的广告段，减少网络请求

**子任务**：
- [ ] 创建批量查询API (`POST /api/v1/segments/batch`)
  - 接收bvid数组
  - 返回所有视频的广告段
  - 优化查询性能

---

前端开发（史少凯、张家昊）

1. 验证跳过功能
**功能描述**：确保跳过广告功能正常工作

**子任务**：
- [ ] 添加详细的调试日志
  - 显示当前播放时间
  - 显示已加载的广告段数量
  - 显示跳过判断过程
- [ ] 手动测试跳过功能
  - 在数据库中插入测试数据
  - 打开对应视频，验证是否跳过
  - 测试不同时间段的情况
- [ ] 优化跳过逻辑
  - 提前0.5秒开始检查
  - 避免频繁跳过（500ms冷却）

2. 显示已标注数量
**功能描述**：在插件弹窗中显示用户标注了多少个广告段

**子任务**：
- [ ] 修改popup.html，确保`display-count`元素存在
- [ ] 在`showUserPanel`函数中获取用户的标注数量
- [ ] 调用`/api/v1/user/contributions` API
- [ ] 更新`display-count`显示
- [ ] 添加刷新功能

3. 添加删除功能
**功能描述**：允许用户删除最近的标注

**子任务**：
- [ ] 在控制栏添加"删除"按钮（🗑️图标）
- [ ] 实现删除确认对话框
- [ ] 调用删除API
- [ ] 显示删除成功/失败提示
- [ ] 刷新本地标注数据

---

🟡 优先级2：投票验证系统

数据库设计（黄瑞琦）

1. 创建投票表
**功能描述**：存储用户对标注的投票记录

**子任务**：
- [ ] 设计`segment_votes`表结构
  - id（主键）
  - segment_id（标注ID，外键）
  - user_id（用户ID，外键）
  - vote_type（投票类型：up/down）
  - created_at（创建时间）
  - 唯一约束：segment_id + user_id（防止重复投票）
- [ ] 创建索引
  - idx_votes_segment（按segment_id查询）
  - idx_votes_user（按user_id查询）
- [ ] 添加外键约束
  - ON DELETE CASCADE（删除标注时删除投票）

2. 创建统计视图
**功能描述**：方便查询投票统计信息

**子任务**：
- [ ] 设计`segment_stats`视图
  - 每个标注的upvotes数
  - 每个标注的downvotes数
  - Wilson置信区间分数
- [ ] 测试视图性能

---

后端开发（朱家佑、李陈熙）

1. 投票功能API
**功能描述**：允许用户对标注进行投票

**子任务**：
- [ ] 创建投票API (`POST /api/v1/segments/:id/vote`)
  - 验证用户登录状态
  - 检查是否已投票
  - 插入或更新投票记录
  - 防止重复投票（唯一约束）
- [ ] 创建获取投票统计API (`GET /api/v1/segments/:id/votes`)
  - 返回赞同数、反对数、总数
  - 返回当前用户的投票状态
- [ ] 添加投票奖励
  - 每次投票+2积分
  - 限制刷票（同一标注不重复奖励）

2. 修改标注查询API
**功能描述**：只返回高质量的标注

**子任务**：
- [ ] 实现置信度过滤
  - 只返回置信度 > 0.7 的标注
  - 使用Wilson置信区间算法
  - 过滤反对过多的标注
- [ ] 添加投票信息到返回结果
  - upvotes、downvotes、total
  - 当前用户的投票状态

---

前端开发（史少凯、张家昊）

1. 投票UI
**功能描述**：在控制栏添加投票按钮

**子任务**：
- [ ] 添加👍赞同按钮
  - 显示当前赞同数
  - 点击后发送投票请求
  - 成功后更新显示
- [ ] 添加👎反对按钮
  - 显示当前反对数
  - 点击后发送投票请求
  - 成功后更新显示
- [ ] 添加投票状态显示
  - "X人赞同 Y人反对"
  - "置信度：95%"

2. 投票反馈
**功能描述**：优化投票体验

**子任务**：
- [ ] 显示投票成功提示
  - "+2分 投票成功"
  - Toast动画效果
- [ ] 高亮已投票的按钮
  - 赞同后按钮变为绿色
  - 反对后按钮变为红色
  - 禁用重复投票
- [ ] 加载投票状态
  - 页面加载时获取用户的投票状态
  - 根据状态设置按钮样式

---

🟢 优先级3：用户体验优化

前端开发（史少凯、张家昊）

1. 设置页面
**功能描述**：创建插件设置页面，允许用户自定义行为

**子任务**：
- [ ] 创建`extension/options/options.html`
  - 自动跳过开关
  - 跳过类型选择（硬广/软广/植入/片头/中段）
  - 保存按钮
- [ ] 创建`extension/options/options.js`
  - 保存用户偏好到chrome.storage
  - 应用设置到content script
  - 读取并显示当前设置
- [ ] 修改manifest.json
  - 添加`options_page`或`options_ui`

2. 快捷键支持
**功能描述**：使用快捷键快速标注

**子任务**：
- [ ] 实现快捷键监听
  - Ctrl+Shift+A：标记开始
  - Ctrl+Shift+B：标记结束
  - Ctrl+Shift+S：提交标注
- [ ] 添加快捷键提示
  - 在插件弹窗中显示快捷键列表
  - 在控制栏显示快捷键提示

3. 标注历史页面
**功能描述**：查看和管理所有标注记录

**子任务**：
- [ ] 创建`extension/history/history.html`
  - 显示所有标注记录
  - 按时间倒序排列
  - 显示视频信息、时间段、类型
- [ ] 创建`extension/history/history.js`
  - 调用`/api/v1/user/contributions` API
  - 渲染列表
  - 实现删除功能
  - 实现分页
- [ ] 修改manifest.json
  - 添加访问历史页面的入口

4. 优化Toast提示
**功能描述**：改进用户反馈

**子任务**：
- [ ] 添加跳过成功的动画效果
  - 渐入渐出
  - 滑动效果
- [ ] 显示更详细的错误信息
  - 具体的错误原因
  - 解决建议

---

后端开发（朱家佑、李陈熙）

1. 性能优化
**功能描述**：提升系统性能

**子任务**：
- [ ] 添加数据库索引
  - videos(bvid, cid)
  - ad_segments(video_id, is_active)
  - segment_votes(segment_id, user_id)
- [ ] 实现缓存机制
  - 使用Redis或内存缓存
  - 缓存热门视频的广告段
  - 缓存用户信息
- [ ] 优化查询语句
  - 使用JOIN代替多次查询
  - 添加查询结果限制

2. 数据导出功能
**功能描述**：允许用户和管理员导出数据

**子任务**：
- [ ] 创建导出用户数据API (`GET /api/v1/user/export`)
  - 返回JSON格式
  - 包含所有标注记录
- [ ] 创建管理员导出API (`GET /api/v1/admin/export/all`)
  - 导出所有标注数据
  - 验证管理员权限

---

🔵 优先级4：数据分析和展示

后端开发（朱家佑、李陈熙）

1. 排行榜API
**功能描述**：提供各种排行榜数据

**子任务**：
- [ ] 创建日贡献榜API (`GET /api/v1/stats/leaderboard/daily`)
- [ ] 创建周贡献榜API (`GET /api/v1/stats/leaderboard/weekly`)
- [ ] 创建总贡献榜API (`GET /api/v1/stats/leaderboard/all`)
- [ ] 创建视频标注榜API (`GET /api/v1/stats/leaderboard/videos`)

2. 统计图表API
**功能描述**：提供统计数据用于图表展示

**子任务**：
- [ ] 创建每日新增标注趋势API (`GET /api/v1/stats/trends/daily`)
  - 最近30天的数据
- [ ] 创建广告类型分布API (`GET /api/v1/stats/distribution/types`)
- [ ] 创建活跃用户统计API (`GET /api/v1/stats/users/active`)

3. 视频分析API
**功能描述**：分析某个视频的广告情况

**子任务**：
- [ ] 创建视频详情API (`GET /api/v1/videos/:bvid/details`)
  - 所有标注信息
  - 标注密度分析
  - 广告类型分布

---

前端开发（史少凯、张家昊）

1. 数据展示页面
**功能描述**：创建数据仪表盘

**子任务**：
- [ ] 创建`extension/dashboard/dashboard.html`
  - 显示总体统计卡片
  - 显示排行榜（日/周/总）
  - 显示统计图表
- [ ] 创建`extension/dashboard/dashboard.js`
  - 调用各种统计API
  - 使用Chart.js渲染图表
  - 定时刷新数据
- [ ] 实现图表功能
  - 折线图：每日新增标注趋势
  - 饼图：广告类型分布
  - 柱状图：TOP贡献者

2. 视频详情页面
**功能描述**：展示某个视频的详细广告信息

**子任务**：
- [ ] 创建视频详情页
  - 显示视频标题、封面
  - 显示所有广告段时间轴
  - 可视化展示（进度条标记）
  - 显示每个标注的投票情况
- [ ] 添加交互功能
  - 点击标注跳转到对应时间
  	- 对标注进行投票
  	- 显示贡献者信息

---

📅 开发计划

第一周（核心功能完善）
**目标**：验证核心功能，添加基础统计

- [ ] 后端：统计API、删除API、批量查询API
- [ ] 前端：验证跳过功能、显示已标注数量、删除按钮
- [ ] 测试：全面测试跳过和标注功能

第二周（投票系统）
**目标**：实现完整的投票验证机制

- [ ] 数据库：创建投票表和视图
- [ ] 后端：投票API、修改查询API
- [ ] 前端：投票UI、投票反馈
- [ ] 测试：测试投票功能

第三周（用户体验）
**目标**：优化用户体验

- [ ] 前端：设置页面、快捷键、历史页面
- [ ] 后端：性能优化、数据导出
- [ ] 测试：用户体验测试

第四周（数据分析）
**目标**：添加数据分析功能

- [ ] 后端：排行榜API、统计API、视频分析API
- [ ] 前端：数据展示页面、视频详情页面
- [ ] 测试：全面测试和bug修复

---

👥 团队分工

| 角色 | 成员 | 主要职责 |
|------|------|----------|
| **后端开发** | 朱家佑、李陈熙 | API开发、性能优化、数据库设计 |
| **数据库** | 黄瑞琦 | 表结构设计、索引优化、数据迁移 |
| **前端开发** | 史少凯、张家昊 | UI开发、交互逻辑、用户体验 |

---

📝 备注

重要注意事项
1. **代码规范**：遵循团队约定的代码风格
2. **测试优先**：每个功能完成后及时测试
3. **文档同步**：API变更后及时更新文档
4. **Git提交**：频繁提交，commit message清晰
5. **沟通协作**：遇到问题及时在团队群讨论

技术栈参考
- 后端：Node.js + Express + SQLite + JWT
- 前端：Chrome Extension API + Vanilla JavaScript
- 数据库：SQLite (better-sqlite3)
- 工具：Chart.js（图表展示）

相关文档
- [Chrome Extension文档](https://developer.chrome.com/docs/extensions/)
- [Express文档](https://expressjs.com/)
- [SQLite文档](https://www.sqlite.org/docs.html)

---

✅ 任务检查清单模板

使用此模板跟踪任务进度：

- [ ] 任务名称
  - 子任务1
  - 子任务2
  - 子任务3
  - 负责人：XXX
  - 预计完成时间：YYYY-MM-DD
  - 实际完成时间：YYYY-MM-DD
  - 备注：

---

*最后更新：2025-02-08*
*文档版本：v1.0*