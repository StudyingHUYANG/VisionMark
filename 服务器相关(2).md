

📘 VisionMark 项目开发与运维规范手册 (v1.0)

1. 核心架构与网络拓扑 (必读)
本项目为了在未备案的国内服务器环境上稳定运行 HTTPS 服务，设计了特殊的端口转发架构。接手人严禁擅自修改此架构，否则将导致服务全线不可用。

1.1 流量走向图
所有的请求必须通过 Nginx 的 8443 端口进入，严禁直接访问 Node.js 的 8080 端口。

客户端 (Extension): 浏览器插件，通过 HTTPS 协议与服务器通信。

入口层 (Nginx): 监听 8443 端口。

设计意图: 避开国内云服务器对未备案域名 80/443 端口的自动拦截。

职责: 负责 SSL 证书卸载（解密），将流量反向代理至后端。

应用层 (Node.js): 监听 8080 端口。

职责: 运行 Express 业务逻辑，处理 API 请求。

数据层 (SQLite): 本地文件数据库 app.db。

1.2 关键参数红线
2. 服务器访问信息 (生产环境)
公网 IP: 81.70.220.123 域名apitest.visionmark.com.cn 用户visionmark 密码 shimakaze&soryu03A

操作系统: OpenCloudOS (兼容 CentOS 8)

SSH 可登录

3. 源码仓库与 Git 规范
后端仓库 (Server)

生产分支: main 

开发分支: dev

前端仓库 (Extension): 这里也要有版本分支，建议命名版本 xx（数据库接口版本）.xx（前端版本）, 因为前端更新较快

🔴 数据库文件规范 (.gitignore)
本项目使用 SQLite (app.db) 存储用户数据。 规范: 绝对禁止将 server/database/app.db 提交到 Git 仓库！ 操作: 确保 .gitignore 包含：

4. 版本迭代与部署规范 (SOP)
4.1 运行目录规范 (原地升级策略)（所有版本代码应保存在github上面，理论上）（不同版本的数据库则应当保留在服务器？）
我们采用**“原地升级”**策略，不创建新目录。

v1.0 (当前) 运行在: /home/visionmark/VisionMark/server

v2.0 (未来) 运行在: /home/visionmark/VisionMark/server (直接覆盖)

❌ 错误做法: 新建 server_v2 文件夹运行。 ✅ 正确做法: 在原目录下 git pull 或解压覆盖代码，保持端口 8080 不变。

4.2 部署流程 (以升级 v2.0 为例)
当 v2.0 代码开发完成并合并到 main 分支后，请在服务器执行以下标准操作：

停止旧服务:

备份数据库 (关键保命步):

更新代码:

数据库迁移 (如有变动): 如果 v2.0 增加了新字段（如 points），请手动运行迁移脚本：

更新依赖:

重启服务:

5. 插件前端发布规范
发布新版插件（.crx/.zip）给用户前，必须通过 Code Review 确认以下两点：

API 地址检查: 打开 extension/content/constants.js (或 popup.js)，确认 API_BASE 指向的是 HTTPS + 8443：

权限声明: 检查 manifest.json 的 host_permissions 是否包含：

6. 常见故障排查 (Troubleshooting)
故障 A: 浏览器报 Mixed Content

原因: 插件请求了 HTTP 地址，或端口写错了。

解决: 检查前端代码 API_BASE 是否为 https://...:8443。

故障 B: 服务器 8443 端口不通

原因: Nginx 未启动或防火墙/SELinux 拦截。

解决:

故障 C: 数据库数据丢失

原因: 部署时直接覆盖了 app.db。

解决: 从 ~/VisionMark/backups/ 目录恢复备份。